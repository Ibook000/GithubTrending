name: 自动生成GitHub趋势榜单

on:
  schedule:
    - cron: '0 2 * * *'  # 每天UTC时间2点（北京时间10点）
  workflow_dispatch:  # 支持手动触发

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # 需要写权限来提交历史文件
      pages: write
      id-token: write

    steps:
      - name: 检出代码
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # 获取完整历史记录

      - name: 恢复历史记录
        run: |
          # 从gh-pages分支获取现有的历史记录
          echo "正在从gh-pages分支恢复历史记录..."

          # 确保本地 history 目录存在
          mkdir -p history

          if git ls-remote --heads origin gh-pages | grep -q gh-pages; then
            # gh-pages 分支存在，尝试恢复历史记录
            echo "gh-pages 分支存在，正在恢复历史记录..."

            # 创建临时目录来存储历史记录
            mkdir -p temp_history

            # 克隆gh-pages分支到临时目录
            git clone --branch gh-pages --single-branch https://github.com/Ibook000/GithubTrending.git temp_history

            # 复制历史记录到当前工作区
            if [ -d "temp_history/history" ]; then
              echo "找到现有历史记录，正在恢复..."
              cp -r temp_history/history/* history/
              record_count=$(ls -1 history/ | wc -l)
              echo "历史记录恢复完成，共恢复 $record_count 条记录"
            else
              echo "gh-pages分支中未找到历史记录目录，将创建新的历史记录"
            fi

            # 清理临时目录
            rm -rf temp_history
          else
            echo "gh-pages分支不存在，将创建新的历史记录"
          fi

          # 确认 history 目录已准备就绪
          if [ -d "history" ]; then
            record_count=$(ls -1 history/ 2>/dev/null | wc -l)
            echo "history 目录已准备就绪，包含 $record_count 个条目"
          else
            echo "错误: history 目录创建失败"
            exit 1
          fi
        continue-on-error: false

      - name: 设置Python环境
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: 安装依赖
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: 网络连接诊断
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
        run: |
          echo "开始网络连接诊断..."
          python test_network.py
        continue-on-error: true

      - name: 生成趋势榜单页面
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          # 设置GitHub Actions标识
          GITHUB_ACTIONS: true
          # 配置网络相关环境变量
          PYTHONUNBUFFERED: 1
          REQUESTS_CA_BUNDLE: /etc/ssl/certs/ca-certificates.crt
        run: |
          echo "配置网络环境..."
          # 显示网络配置信息
          echo "DNS配置:"
          cat /etc/resolv.conf
          echo "测试网络连接:"
          curl -I https://openrouter.ai --connect-timeout 10 || echo "OpenRouter连接测试失败"

          echo "开始生成趋势榜单..."
          python github_trending_cards.py

          # 确保生成了HTML文件
          if [ ! -f "github_trending_cards.html" ]; then
            echo "HTML文件生成失败"
            exit 1
          fi
          echo "HTML文件生成成功"

          # 显示生成的文件信息
          ls -la github_trending_cards.*

      - name: 保存历史页面
        run: |
          # 获取当前日期
          DATE=$(date +%Y-%m-%d)
          echo "当前日期: $DATE"

          # 确保 history 目录存在
          if [ ! -d "history" ]; then
            echo "history 目录不存在，创建新目录"
            mkdir -p history
          else
            echo "history 目录已存在，包含 $(ls -1 history/ | wc -l) 条记录"
          fi

          # 创建日期子目录
          mkdir -p "history/$DATE"
          echo "创建历史记录目录: history/$DATE/"

          # 检查要复制的文件是否存在
          if [ -f "github_trending_cards.html" ]; then
            cp github_trending_cards.html "history/$DATE/index.html"
            echo "已复制 HTML 文件"
          else
            echo "错误: github_trending_cards.html 不存在"
            exit 1
          fi

          if [ -f "github_trending_cards.css" ]; then
            cp github_trending_cards.css "history/$DATE/github_trending_cards.css"
            echo "已复制 CSS 文件"
          else
            echo "警告: github_trending_cards.css 不存在"
          fi

          # 检查并复制图片文件
          if [ -f "展示1.png" ]; then
            cp "展示1.png" "history/$DATE/"
            echo "已复制 展示1.png"
          fi
          if [ -f "img.png" ]; then
            cp "img.png" "history/$DATE/"
            echo "已复制 img.png"
          fi

          # 创建元数据文件
          METADATA="{
            \"date\": \"$DATE\",
            \"generated_at\": \"$(date -u +\"%Y-%m-%dT%H:%M:%SZ\")\",
            \"source\": \"GitHub Trending Scraper\"}"
          echo $METADATA > "history/$DATE/metadata.json"
          echo "已创建元数据文件"

      - name: 创建发布文件夹
        run: |
          # 创建用于发布到gh-pages的文件夹
          mkdir -p gh-pages

      - name: 复制文件到发布文件夹
        run: |
          # 复制所有需要发布的文件
          cp index.html gh-pages/
          cp github_trending_cards.html gh-pages/index.html
          cp github_trending_cards.css gh-pages/
          cp README_GHPAGES.md gh-pages/README.md
          cp img.png gh-pages/ 2>/dev/null || echo "img.png 文件不存在，跳过复制"
          
          # 复制历史目录
          cp -r history/ gh-pages/

      - name: 生成历史统计页面
        run: |
          python generate_history_stats.py
          cp history/index.html gh-pages/history/

      - name: 部署到 GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./gh-pages
          publish_branch: gh-pages
          force_orphan: true
          user_name: "github-actions[bot]"
          user_email: "github-actions[bot]@users.noreply.github.com"