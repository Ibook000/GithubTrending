name: ğŸš€ è‡ªåŠ¨ç”ŸæˆGitHubè¶‹åŠ¿æ¦œå•

on:
  schedule:
    - cron: '0 2 * * *'  # æ¯å¤©UTCæ—¶é—´2ç‚¹ï¼ˆåŒ—äº¬æ—¶é—´10ç‚¹ï¼‰
  workflow_dispatch:  # æ”¯æŒæ‰‹åŠ¨è§¦å‘

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # éœ€è¦å†™æƒé™æ¥æäº¤å†å²æ–‡ä»¶
      pages: write
      id-token: write

    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²è®°å½•

      - name: ğŸ è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: ğŸ” ç½‘ç»œè¿æ¥è¯Šæ–­
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
        run: |
          echo "ğŸ” å¼€å§‹ç½‘ç»œè¿æ¥è¯Šæ–­..."
          python test_network.py
        continue-on-error: true

      - name: ğŸ¯ ç”Ÿæˆè¶‹åŠ¿æ¦œå•é¡µé¢
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          # è®¾ç½®GitHub Actionsæ ‡è¯†
          GITHUB_ACTIONS: true
          # é…ç½®ç½‘ç»œç›¸å…³ç¯å¢ƒå˜é‡
          PYTHONUNBUFFERED: 1
          REQUESTS_CA_BUNDLE: /etc/ssl/certs/ca-certificates.crt
        run: |
          echo "ğŸŒ é…ç½®ç½‘ç»œç¯å¢ƒ..."
          # æ˜¾ç¤ºç½‘ç»œé…ç½®ä¿¡æ¯
          echo "DNSé…ç½®:"
          cat /etc/resolv.conf
          echo "æµ‹è¯•ç½‘ç»œè¿æ¥:"
          curl -I https://openrouter.ai --connect-timeout 10 || echo "âš ï¸ OpenRouterè¿æ¥æµ‹è¯•å¤±è´¥"
          
          echo "ğŸš€ å¼€å§‹ç”Ÿæˆè¶‹åŠ¿æ¦œå•..."
          python github_trending_cards.py
          
          # ç¡®ä¿ç”Ÿæˆäº†HTMLæ–‡ä»¶
          if [ ! -f "github_trending_cards.html" ]; then
            echo "âŒ HTMLæ–‡ä»¶ç”Ÿæˆå¤±è´¥"
            exit 1
          fi
          echo "âœ… HTMLæ–‡ä»¶ç”ŸæˆæˆåŠŸ"
          
          # æ˜¾ç¤ºç”Ÿæˆçš„æ–‡ä»¶ä¿¡æ¯
          echo "ğŸ“„ ç”Ÿæˆçš„æ–‡ä»¶:"
          ls -la github_trending_cards.*

      - name: ğŸ“… æ£€å‡ºgh-pagesåˆ†æ”¯
        run: |
          # åˆ›å»ºä¸´æ—¶å·¥ä½œç›®å½•
          mkdir -p temp_gh_pages
          cd temp_gh_pages
          
          # åˆå§‹åŒ–Gitä»“åº“
          git init
          git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # æ‹‰å–gh-pagesåˆ†æ”¯
          git remote add origin https://github.com/${{ github.repository }}.git
          git fetch origin gh-pages || echo "âš ï¸ gh-pagesåˆ†æ”¯ä¸å­˜åœ¨ï¼Œå°†åˆ›å»ºæ–°åˆ†æ”¯"
          git checkout -b gh-pages origin/gh-pages 2>/dev/null || git checkout -b gh-pages
          
          echo "âœ… gh-pagesåˆ†æ”¯å·²æ£€å‡º"

      - name: ğŸ“Š ç”Ÿæˆå†å²ç»Ÿè®¡é¡µé¢
        run: |
          # åœ¨åŸå§‹ç›®å½•ç”Ÿæˆç»Ÿè®¡é¡µé¢
          python generate_history_stats.py
          
          # éªŒè¯ç»Ÿè®¡é¡µé¢ç”Ÿæˆ
          if [ -f "history/index.html" ]; then
            echo "âœ… å†å²ç»Ÿè®¡é¡µé¢å·²ç”Ÿæˆ"
          else
            echo "âŒ å†å²ç»Ÿè®¡é¡µé¢ç”Ÿæˆå¤±è´¥"
            exit 1
          fi

      - name: ğŸ“… ä¿å­˜å†å²é¡µé¢åˆ°gh-pages
        run: |
          # è·å–å½“å‰æ—¥æœŸ
          DATE=$(date +%Y-%m-%d)
          echo "ğŸ“… ä¿å­˜å†å²é¡µé¢åˆ°gh-pages: $DATE"
          
          # å¤åˆ¶æ–‡ä»¶åˆ°gh-pagesç›®å½•
          cd temp_gh_pages
          
          # åˆ›å»ºå†å²ç›®å½•ç»“æ„
          mkdir -p "history/$DATE"
          
          # å¤åˆ¶å½“å‰ç”Ÿæˆçš„æ–‡ä»¶
          cp ../github_trending_cards.html "history/$DATE/index.html"
          cp ../github_trending_cards.css "history/$DATE/github_trending_cards.css"
          
          # å¤åˆ¶å±•ç¤ºå›¾ç‰‡
          if [ -f "../img.png" ]; then
            cp "../img.png" "history/$DATE/"
          fi
          
          # å¤åˆ¶å†å²ç»Ÿè®¡é¡µé¢
          if [ -f "../history/index.html" ]; then
            cp "../history/index.html" "history/index.html"
          fi
          
          # åˆ›å»ºè¯¦ç»†çš„å…ƒæ•°æ®
          cat > "history/$DATE/metadata.json" << EOF
          {
            "date": "$DATE",
            "generated_at": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "timestamp": $(date +%s),
            "source": "GitHub Trending",
            "workflow_run": "${{ github.run_number }}",
            "git_commit": "${{ github.sha }}",
            "repository": "${{ github.repository }}"
          }
          EOF
          
          # éªŒè¯å†å²ç›®å½•å®Œæ•´æ€§
          echo "ğŸ” éªŒè¯gh-pageså†å²ç›®å½•:"
          ls -la "history/$DATE/"
          
          # ç»Ÿè®¡å†å²å¤©æ•°
          TOTAL_DAYS=$(find history -maxdepth 1 -type d -name "20*" | wc -l)
          echo "ğŸ“Š æ€»å†å²å¤©æ•°: $TOTAL_DAYS"

      - name: ğŸ“„ å‡†å¤‡gh-pageså‘å¸ƒæ–‡ä»¶
        run: |
          cd temp_gh_pages
          
          echo "ğŸ“ å‡†å¤‡gh-pageså‘å¸ƒæ–‡ä»¶..."
          
          # å¤åˆ¶æœ€æ–°ç‰ˆæœ¬åˆ°æ ¹ç›®å½•
          cp ../github_trending_cards.html index.html
          cp ../github_trending_cards.css styles.css
          
          # å¤åˆ¶å±•ç¤ºå›¾ç‰‡
          if [ -f "../img.png" ]; then
            cp "../img.png" .
          fi
          
          # åˆ›å»ºREADME
          cat > README.md << EOF
          # GitHubè¶‹åŠ¿æ¦œå• - GitHub Pages
          
          è‡ªåŠ¨ç”Ÿæˆçš„GitHubè¶‹åŠ¿æ¦œå•ï¼Œæ¯æ—¥æ›´æ–°ã€‚
          
          ## ğŸ“… ä»Šæ—¥ä¿¡æ¯
          - **ç”Ÿæˆæ—¶é—´**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          - **å·¥ä½œæµç¼–å·**: ${{ github.run_number }}
          - **æäº¤å“ˆå¸Œ**: ${{ github.sha }}
          
          ## ğŸ”— å¿«é€Ÿè®¿é—®
          - [ğŸ  æœ€æ–°æ¦œå•](https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/)
          - [ğŸ“Š å†å²ç»Ÿè®¡](https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/history/)
          - [ğŸ“ é¡¹ç›®ä»“åº“](https://github.com/${{ github.repository }})
          
          ## ğŸ“ˆ å†å²è®°å½•
          æ‰€æœ‰å†å²æ•°æ®éƒ½ä¿å­˜åœ¨ \`history/\` ç›®å½•ä¸­ï¼ŒæŒ‰æ—¥æœŸåˆ†ç±»å­˜å‚¨ã€‚
          
          ## ğŸ“Š æ•°æ®ç»Ÿè®¡
          - **æ€»è®°å½•å¤©æ•°**: $(find history -maxdepth 1 -type d -name "20*" | wc -l)
          - **æœ€åæ›´æ–°**: $(date +%Y-%m-%d)
          
          ---
          *ç”±GitHub Actionsè‡ªåŠ¨ç”Ÿæˆ* ğŸ¤–
          EOF
          
          # åˆ›å»ºCNAMEæ–‡ä»¶ï¼ˆå¦‚æœéœ€è¦è‡ªå®šä¹‰åŸŸåï¼‰
          # echo "your-domain.com" > CNAME
          
          # åˆ›å»º.gitignore
          echo "*.log" > .gitignore
          echo ".DS_Store" >> .gitignore
          
          # æ˜¾ç¤ºå‘å¸ƒæ–‡ä»¶ç»“æ„
          echo "ğŸ“‚ gh-pagesæ–‡ä»¶ç»“æ„:"
          find . -type f | head -20 | sed 's/^/  /'
          
          # è®¡ç®—æ–‡ä»¶å¤§å°
          TOTAL_SIZE=$(du -sh . | cut -f1)
          echo "ğŸ“Š gh-pagesæ€»å¤§å°: $TOTAL_SIZE"

      - name: ğŸš€ æäº¤å¹¶æ¨é€gh-pages
        run: |
          cd temp_gh_pages
          
          echo "ğŸš€ å‡†å¤‡æäº¤gh-pages..."
          
          # æ·»åŠ æ‰€æœ‰æ–‡ä»¶
          git add .
          
          # åˆ›å»ºæäº¤ä¿¡æ¯
          DATE=$(date +%Y-%m-%d)
          COMMIT_MSG="ğŸ¨ æ›´æ–°GitHubè¶‹åŠ¿æ¦œå• - $DATE
          
          - ç”Ÿæˆæ—¶é—´: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          - å·¥ä½œæµç¼–å·: ${{ github.run_number }}
          - æäº¤å“ˆå¸Œ: ${{ github.sha }}
          - å†å²å¤©æ•°: $(find history -maxdepth 1 -type d -name "20*" | wc -l)"
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹
          if ! git diff --staged --quiet; then
            echo "ğŸ“ æ£€æµ‹åˆ°æ–‡ä»¶æ›´æ”¹ï¼Œæ­£åœ¨æäº¤..."
            git commit -m "$COMMIT_MSG"
            
            # æ¨é€gh-pagesåˆ†æ”¯
            echo "ğŸš€ æ¨é€gh-pagesåˆ†æ”¯..."
            git push -f origin gh-pages
            echo "âœ… gh-pagesåˆ†æ”¯å·²æ›´æ–°"
          else
            echo "âœ… æ— æ–‡ä»¶æ›´æ”¹ï¼Œè·³è¿‡æäº¤"
          fi

      - name: ğŸ§¹ æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        run: |
          rm -rf temp_gh_pages
          echo "ğŸ§¹ ä¸´æ—¶æ–‡ä»¶å·²æ¸…ç†"